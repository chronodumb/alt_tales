<html>
    <head>

        <script src="js/jquery.min.js"></script>
        <script>
            var faces = ["","⚀","⚁","⚂","⚃","⚄","⚅"];

            var deck = [];

            var state = {
                turn : 0,
                players: {
                    "p1" : {
                        "name":"Player 1",
                        "score":0,
                        "dice": [1,1,1,1,1,1],
                        "reroll":true,
                    },
                    "p2" : {
                        "name":"Player 2",
                    },
                    "p3": {
                        "name":"Player 3",
                    },
                    "p4": {
                        "name":"Player 4",
                    }
                },
                deck: [],
                cards: [
                    {
                        "pattern":111,
                        "point":5,
                        "bid":{
                            "p1": [],
                            "p2": [],
                            "p3": [],
                            "p4": [],
                        }
                    }
                ],



            }

            var combo = [
                {"pattern": "111"    , "point" :  5},
                {"pattern": "222"    , "point" :  5},
                {"pattern": "333"    , "point" :  5},
                {"pattern": "444"    , "point" :  5},
                {"pattern": "555"    , "point" :  5},
                {"pattern": "666"    , "point" :  5},
                {"pattern": "123"    , "point" :  5},
                {"pattern": "234"    , "point" :  5},
                {"pattern": "456"    , "point" :  5},
                {"pattern": "135"    , "point" :  5},
                {"pattern": "236"    , "point" :  5},
                {"pattern": "1122"   , "point" : 10},
                {"pattern": "1133"   , "point" : 10},
                {"pattern": "1144"   , "point" : 10},
                {"pattern": "1155"   , "point" : 10},
                {"pattern": "1166"   , "point" : 10},
                {"pattern": "2233"   , "point" : 10},
                {"pattern": "2244"   , "point" : 10},
                {"pattern": "2255"   , "point" : 10},
                {"pattern": "2266"   , "point" : 10},
                {"pattern": "3344"   , "point" : 10},
                {"pattern": "3355"   , "point" : 10},
                {"pattern": "3366"   , "point" : 10},
                {"pattern": "4455"   , "point" : 10},
                {"pattern": "4466"   , "point" : 10},
                {"pattern": "5566"   , "point" : 10},
                {"pattern": "111111" , "point" : 15},
                {"pattern": "222222" , "point" : 15},
                {"pattern": "333333" , "point" : 15},
                {"pattern": "444444" , "point" : 15},
                {"pattern": "555555" , "point" : 15},
                {"pattern": "666666" , "point" : 15},
            ];

            console.log(combo.length)


            //move this to server side;
            function diceRoll(die,f){
                //var f = roll();
                $(die).addClass("rolling");

                setTimeout(function(die){
                    $(die).removeClass("rolling");
                    // $(die).children(".face").html(faces[f]);
                }, 1000, die);

            }

            function roll(){
                return Math.floor(Math.random() * ((6 - 1) + 1) + 1);
            }


            function rollAll(pid){
                console.log("roll");
                coverUp(2000)

                $("."+pid+" .die").hide();

                //GET THIS VALUE FROM SERVERSIDE
                dice = state.players[pid].dice;
                for (var i=0; i<dice.length; i++){
                    dice[i] = roll();
                    var n =  $("."+pid+" .die"+i);

                    $(n).children(".face").html(faces[dice[i]]);

                    setTimeout(function(n){n.show();diceRoll(n);},200*i,n);
                }

                // $("."+pid+" .die").each(function(i,n){
                //     console.log(i + "," + n);
                //     setTimeout(function(n){diceRoll(n,dice[i]);},200*i,n);
                // })
            }

            function status(){
                console.log(state);
            }

            function coverUp(ms,text){
                $(".cover").show();
                setTimeout(function(){
                    $(".cover").hide();
                },ms);
            }

            function reroll(pid){
                rollAll(pid)
            }

            function turn(pid){
                console.log("turn " + pid);
                rollAll(pid);
            }


            function init(){
                console.log("start game");


                deal();




                turn("p1");
            }

            function deal(){
                deck=combo.splice(0);
                shuffle(deck);
                draw();draw();draw();
            }

            function shuffle(array) {
                console.log("shuffle");

                for (var i = array.length - 1; i > 0; i--) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = array[i];
                    array[i] = array[j];
                    array[j] = temp;
                }
            }

            function draw(){
                var card = deck.splice(0,1)[0];

                console.log(card);

                $(".cards").append("<div class=\"card\" ><div class=\"box\" > <div class=\"face\"> " + getFaces(card.pattern) + " </div> <div class=\"point\"> " + card.point + " </div> </div> <div class=\"bid\"> <div class=\"p1 d\"></div> <div class=\"p2 d\"></div> <div class=\"p3 d\"></div> <div class=\"p4 d\"></div> </div></div>");
            }


            String.prototype.replaceAll = function(search, replacement) {
                var target = this;
                return target.replace(new RegExp(search, 'g'), replacement);
            };


            function getFaces(pattern){
                pattern = pattern.replaceAll("1","⚀ ");
                pattern = pattern.replaceAll("2","⚁ ");
                pattern = pattern.replaceAll("3","⚂ ");
                pattern = pattern.replaceAll("4","⚃ ");
                pattern = pattern.replaceAll("5","⚄ ");
                pattern = pattern.replaceAll("6","⚅ ");

                return pattern;
            }

            function bid(die){
                $(".die"+die).addClass("dragged");
            }

            function place(die){
                console.log("dropped");
                $(".die"+die).removeClass("dragged");
            }



            $(document).ready(function(){
                init();
            })
        </script>
        <style>
            .die {
                font-family: "Arial";
                font-size:24px;
                width:30px;
                height:30px;
                z-index:2;
                cursor:move;
                user-select: none;
                display:inline-block;
                opacity:1;
            }


            .die.rolling {
                pointer-events:none;
            }
            .die.rolling .bounce{
                display:block;
            }
            .die.rolling .face{
                display:none;
            }

            .bounce{
                animation: shake 1s;
                display:none;
            }

            .roll {
                animation: spin 1.6s;
                text-align:center;
            }

            @keyframes spin {
                0% {transform:rotate(180deg)}
                0% {transform:rotate(0deg)}
                100% {transform:rotate(-360deg)}
            }

            @keyframes shake {
                10%, 90% {
                    transform: translate3d(0, -1px, 0);
                }

                20%, 80% {
                    transform: translate3d(0, 2px, 0);
                }

                50% {
                    transform: translate3d(0, -8px, 0);
                }

                30%, 70% {
                    transform: translate3d(0, -4px, 0);
                }

                40%, 60% {
                    transform: translate3d(0, -4px, 0);
                }
            }

            .p {
                border:2px solid;
                width:300px;
                height: 50px;
                margin:10px;
                padding: 5px;
                position:relative;
            }

            .name{
                width:200px;
                position:relative;
            }

            .score{
                width:100px;
                position:absolute;
                top:0;
                right:0;
                text-align: right;
            }

            .options{
                width: 80px;
                position:absolute;
                top:0;
                right:0;
                text-align: center;
            }

            .options input{
                margin:3px;
                width:65px;
            }

            .cards{
                width:500px;
            }

            .card {
                display:inline-block;
                height:200px;
            }
            .card .box {
                width:80px;
                height:120px;
                margin:5px;
                border: 2px solid;
                display:inline-block;
                position:relative;
                vertical-align: top;
            }
            .card .face{
                font-family: "Arial";
                font-size:30px;
                text-align:center;
            }

            .card .point{
                position:absolute;
                bottom:0;
                right:0;
                border:1px solid;
                width:20px;
                height:20px;
                text-align:center;
                border-radius:50%;
            }

            .cover {
                width:100%;
                height:100%;
                top:0;
                left:0;
                z-index:10;
                position:absolute;
                display:none;
            }

            .p1.d, .p1 .die{
                color:red;
            }

            .d{
                height:16px
            }

            .die.dragged {
                opacity:0.4;
            }


        </style>
    </head>
    <body>
        <div class="cover">

        </div>


        <div class="cards">
            <div class="card"><div class="box"> <div class="face"> ⚄ ⚄ ⚅ ⚅  </div> <div class="point"> 10 </div> </div>

            <div class="bid">
                <div class="p1 d"></div>
                <div class="p2 d"></div>
                <div class="p3 d"></div>
                <div class="p4 d"></div>
            </div>

            </div>
        </div>

        <div class="p p1" >
            <div class="name">
                P1

                <span class="score">
                    Score: 0
                </span>
            </div>
            <div class="field">
                <div class="die die0" face="1" draggable="true" ondragover="bid(0)" ondrop="place(0)" >
                    <div class="face state">
                        ⚀
                    </div>
                    <div class="bounce state">
                        <div class="roll">
                            🎲
                        </div>
                    </div>
                </div>

                <div class="die die1" face="1" draggable="true" ondragover="bid(1)" ondrop="place(1)" >
                    <div class="face state">
                        ⚀
                    </div>
                    <div class="bounce state">
                        <div class="roll">
                            🎲
                        </div>
                    </div>
                </div>

                <div class="die die2" face="1" draggable="true" ondragover="bid(2)" ondrop="place(2)" >
                    <div class="face state">
                        ⚀
                    </div>
                    <div class="bounce state">
                        <div class="roll">
                            🎲
                        </div>
                    </div>
                </div>

                <div class="die die3" face="1" draggable="true" ondragover="bid(3)" ondrop="place(3)" >
                    <div class="face state">
                        ⚀
                    </div>
                    <div class="bounce state">
                        <div class="roll">
                            🎲
                        </div>
                    </div>
                </div>

                <div class="die die4" face="1" draggable="true" ondragover="bid(4)" ondrop="place(4)" >
                    <div class="face state">
                        ⚀
                    </div>
                    <div class="bounce state">
                        <div class="roll">
                            🎲
                        </div>
                    </div>
                </div>

                <div class="die die5" face="1" draggable="true" ondragover="bid(5)" ondrop="place(5)" >
                    <div class="face state">
                        ⚀
                    </div>
                    <div class="bounce state">
                        <div class="roll">
                            🎲
                        </div>
                    </div>
                </div>

            </div>

            <div class="options">

                <input type="button" value="Re-roll" onclick="reroll('p1')"/>
                <input type="button" value="End turn"/>

            </div>
        </div>

    </body>
</html>